<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <script src="/jquery.js"></script>
    <script></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="/fabric.min.js"></script>
    <script type="text/javascript" src="/algo.visual.toolbox.js"></script>
	<script type="text/javascript" src="/rx.all.min.js"></script>
    <!--<script type="text/javascript" src="/textillate.js"></script> -->
	<script type="text/javascript" src="/diff-match-patch.js"></script>
	
	
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG">
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript">
        Array.prototype.max = function() {
            return Math.max.apply(null, this);
        };
    </script>
    <style>
		.ui-dialog {
			z-index: 50000; !important
		}
		.rc-handle-container {
		  position: relative;
		}
		.rc-handle {
		  position: absolute;
		  width: 7px;
		  cursor: ew-resize;
		  margin-left: -3px;
		  z-index: 2;
		}
		table.rc-table-resizing {
		  cursor: ew-resize;
		}
		table.rc-table-resizing thead,
		table.rc-table-resizing thead > th,
		table.rc-table-resizing thead > th > a {
		  cursor: ew-resize;
		}
        canvas {
            height: 100vh;
            width: 100vw;
            display: block;
        }
		
		.play {
			display: block;
			width: 0;
			height: 0;
			border-top: 50px solid transparent;
			border-bottom: 50px solid transparent;
			border-left: 60px solid #2c3e50;
			margin: 0px auto 0px auto;
			position: relative;
			z-index: 1;
			transition: all 0.3s;
			-webkit-transition: all 0.3s;
			-moz-transition: all 0.3s;
			left: 10px;
		}
		
		.play:before {
			content: '';
			position: absolute;
			top: -75px;
			left: -115px;
			bottom: -75px;
			right: -35px;
			border-radius: 50%;
			border: 10px solid #2c3e50;
			z-index: 2;
			transition: all 0.3s;
			-webkit-transition: all 0.3s;
			-moz-transition: all 0.3s;
		}

		.play.active:after {
			content: '';
			opacity: 1;
			width: 50px;
			height: 80px;
			background: #2c3e50;
			position: absolute;
			right: 5px;
			top: -40px;
			border-left: 20px solid #2c3e50;
			box-shadow: inset 30px 0 0 0 #f9f9f9;
		}
		.play:after {
			content: '';
			opacity: 0;
			transition: opacity 0.6s;
			-webkit-transition: opacity 0.6s;
			-moz-transition: opacity 0.6s;
		}
		
		.play.active {
			border-color: transparent;
		}
    </style>
</head>

<body >
	<canvas id="playerCanvas"></canvas>
    <canvas id="overlayCanvas" style="position: absolute;"></canvas>
	<span id="recording-info" style="    margin-left: 42%;top: 0; position: fixed;"></span>
	<div id="textillateContainer" style="width: 100%; height: 100%;position: absolute; top: 0; left: 0;"></div>
	
    <script type="text/javascript">
        var API_HOST = 'http://livintolearn.com/api';
        var id = window.location.hash.replace("#", "")
            /*  $.ajax(`${API_HOST}/articleAccessories/${id}`).then(resp => {
      //console.log(resp); //Content loaded
      var speeches = resp.speechTexts
      var animations = resp.animationScripts
      console.log(speeches)
      console.log(animations)
         var playerCanvas = new fabric.Canvas('playerCanvas')
         var _ = {}
         var playerCanvasObjects = _;
         var _pc = playerCanvas;
      new timer(Object.keys(speeches).map(x => Number.parseInt(x)).max(), t => {
            if(animations[t]) eval(animations[t]);
         });
    }) */
        window.pc = new fabric.Canvas('playerCanvas')
        window._ = {
            textboxes: []
        }
        window.oc = new fabric.Canvas('overlayCanvas', {
            isDrawingMode: true
        });
        pc.setWidth(window.innerWidth)
        pc.setHeight(window.innerHeight)
        oc.setWidth(window.innerWidth)
        oc.setHeight(window.innerHeight)

        function superimposeOverlayCanvas() {
            var pos = $('#playerCanvas').position()
            $('#overlayCanvas').css({
                position: 'absolute',
                top: pos.top,
                left: pos.left,
                width: $('#playerCanvas').width(),
                height: $('#playerCanvas').height()
            });
        }


        function showToolbar() {
            $('#toolbar').show();
        }

        function hideToolbar() {
            $('#toolbar').show();
        }
        $('.canvas-container').css({
            position: 'absolute'
        });
        superimposeOverlayCanvas()
        moveToFront('pc')

        function changeCircleColor(c) {
            try {
                pc.getActiveObject()._objects[0].setFill(c)

            } catch (e) {
                try {
                    pc.getActiveObject().setFill(c)
                } catch (e) {
                    console.log(e);
                }
            }
            pc.renderAll()
        }

        function flipConnectionMode() {
            var connectionModeOn = window.connectionMode || false;

            window.connectionMode = !connectionModeOn
            if (window.connectionMode) $('#flipConnectionMode').css({
                backgroundColor: 'blue'
            })
            else $('#flipConnectionMode').css({
                backgroundColor: ''
            })

            window.firstOfConnection = null
        }

        function selectFirstOfConnection(e) {
            window.firstOfConnection = pc.getActiveObject()
        }

        function makeConnection(e) {
            if (window.firstOfConnection) {
                connect(pc, firstOfConnection, pc.getActiveObject())
                window.firstOfConnection = null
            }
        }

        function getScript(id) {
            $.ajax(`/api/${id}`).then(resp => {
                console.log(resp)
                window.jsToExecute = {
                    lines: resp,
                    index: 0
                }
            })
        }
        var id = window.location.hash.replace("#", "")
        if (id) getScript(id)

        function executeNextLine() {
            if (window.jsToExecute) {
                eval(window.jsToExecute.lines[window.jsToExecute.index])
                window.jsToExecute.index = window.jsToExecute.index + 1
            }
        }

        function zoomSelectedObject(isPlus) {
            if (!pc.getActiveObject()) return;
            var amount = 1.5

            if (isPlus) {
                var activeObject = pc.getActiveObject()
                activeObject.scaleX = activeObject.scaleX * amount
                activeObject.scaleY = activeObject.scaleY * amount

            } else {
                var activeObject = pc.getActiveObject()
                activeObject.scaleX = activeObject.scaleX / amount
                activeObject.scaleY = activeObject.scaleY / amount

            }
            activeObject.setCoords();
            pc.renderAll()
        }

        function moveActiveObject(prop, amount) {
            var activeObject = pc.getActiveObject()
            activeObject[prop] = activeObject[prop] + amount
            activeObject.setCoords();
            pc.renderAll()
        }

        function deleteSelectedObjects() {
            pc.remove(pc.getActiveObject())
            if (pc.getActiveGroup()) {
                pc.getActiveGroup()._objects.forEach(x => pc.remove(x))
            }
            pc.renderAll()
        }

        function Copy(canvas) {
            // clone what are you copying since you
            // may want copy and paste on different moment.
            // and you do not want the changes happened
            // later to reflect on the copy.
            var target = canvas.getActiveObject() || canvas.getActiveGroup();
            target.clone(function(cloned) {
                _clipboard = cloned;
            });
        }

        function Paste(canvas) {
            if (!_clipboard) return;
            // clone again, so you can do multiple copies.
            _clipboard.clone(function(clonedObj) {
                canvas.discardActiveObject();
                canvas.discardActiveGroup();

                var options = {
                    left: clonedObj.left + 10,
                    top: clonedObj.top + 10,
                    evented: true,
                };

                clonedObj.set(options);

                if (clonedObj.type === 'activeSelection') {
                    // active selection needs a reference to the canvas.
                    clonedObj.canvas = canvas;
                    clonedObj.forEachObject(function(obj) {
                        canvas.add(obj);
                        var tr = obj.calcTransformMatrix()
                        options.left = obj.left + 10 + tr[4]
                        options.top = obj.top + 10 + tr[5]
                        obj.set(options)
                        obj.setCoords();
                    });

                } else {
                    canvas.add(clonedObj);
                }
                _clipboard.top += 10;
                _clipboard.left += 10;
                //canvas.setActiveObject(clonedObj);
                canvas.renderAll();
            });
        }

        function editSelectedObject() {
            if (!pc.getActiveObject()) return;
            var obj = pc.getActiveObject()

            var p = prompt('Enter command')
            if (!p || !p.split(":").length == 2) return

            var command = p.split(":")[0]
            var data = p.split(":")[1].trim()

            if (!obj._objects || obj._objects.length < 2) return;

            switch (command) {
                case 'bg':
                    obj._objects[0].set({
                        fill: data
                    })
                    break
                case 'fg':
                    obj._objects[1].set({
                        fill: data
                    })
                    break
                case 'text':
                    obj._objects[1].set({
                        text: data
                    })
                    break
				case 'anim':
					highlightByZooming(obj, pc)
					break
				case 'stop'	:
					stopAnimation(obj, pc)
					break
				case 'controls':
					obj.hasControls = data === 'on' ? true: false
					break;
				case 'hide': 
					
					break;
				case 'show': 
					
					break;
				case 'rm': 
					
					break;
            }
            pc.renderAll();
        }

        function makeLine(coords) {
            return new fabric.Line(coords, {
                fill: 'red',
                stroke: 'red',
                strokeWidth: 2,
                selectable: false
            });
        }

        function makeSubtree(node, values, pc, opts) {
            var options = opts || {
                width: 150,
                height: 50
            };

            node.treeConnection = node.treeConnection || {
                incoming: {},
                outgoing: {}
            };

            if (node.oCoords && node.oCoords.mb) {
                var px = node.oCoords.mb.x,
                    py = node.oCoords.mb.y;
                node.treeConnection.outgoing = {
                    lines: [],
                    point: 'mb'
                }

                var mid = Math.ceil(values.length / 2)
                if (values.length == 1) mid = 0;

                var w = (options.width / 2) / values.length;

                var x = px,
                    y = py + options.height;

                var addConnection = (x1, y1, x2, y2, text) => {
                    var circ = textInEllipse(text, x2, y2, {}, {})
                    pc.add(circ)
                    var line = makeLine([x1, y1, circ.oCoords.mt.x, circ.oCoords.mt.y])
                    pc.add(line)
                    node.treeConnection.outgoing.lines.push(line)

                    circ.treeConnection = {
                        incoming: {
                            lines: [line],
                            point: 'mt'
                        }
                    }
                }

                addConnection(px, py, x, y, values[mid])

                for (var i = mid - 1; i >= 0; i--) {
                    x = x - w;
                    addConnection(px, py, x, y, values[i])
                }

                x = px, y = py;

                for (var i = mid + 1; i < values.length; i++) {
                    x = x + w;
                    addConnection(px, py, x, y, values[i])
                }
            }
        }

        function drawMathSymbols(text, canvas) {
            matex(text, function(svg, width, height) {
                // Here you have a data url for a svg file
                // Draw using FabricJS:
                fabric.Image.fromURL(svg, function(img) {
                    img.height = height;
                    img.width = width;
                    img.left = matexInsertionPoint.left
                    img.top = matexInsertionPoint.top
                    canvas.add(img);
                });
            });
        }

        function onMakeTreeClick() {
            if (!pc.getActiveObject()) {
                alert('Select an object first');
                return;
            }
            var p = prompt('Enter command')
            if (!p) return;
            makeSubtree(pc.getActiveObject(), p.split(','), pc)
        }


        function onRemoveTreeClick() {
            if (!pc.getActiveObject()) {
                alert('Select an object first');
                return;
            }
            var obj = pc.getActiveObject()

            if (obj.treeConnection && obj.treeConnection.outgoing) {
                obj.treeConnection.outgoing.lines.forEach(l => {
                    pc.remove(l);
                })
            }
            obj.treeConnection = null
        }

        function arrowButton() {
            if (!window.arrowButtonClicked) {
                window.arrowButtonClicked = {}
            }
        }

        function degroup(pc) {
            var grp = pc.getActiveObject()
            if (grp.type != 'group') return;
            var items = grp.getObjects() || []
            grp.destroy();
            pc.remove(grp);
            items.forEach(item => pc.add(item));
            items.forEach(item => item.hasControls = false);
        }

        window.drawingStack = []
        function undoDrawing(){
            var last = oc.getObjects().pop()
            oc.remove(last)
            drawingStack.push(last)
            oc.renderAll();
        }
        function redoDrawing(){
            var last = drawingStack.pop()
            oc.add(last)
            oc.renderAll();
        }
		
		function moveToFront(whichOne){
			switch(whichOne){
				case 'pc':
					$('.canvas-container').css({ zIndex: -2000 })
					$('#textillateContainer').css({ zIndex: -2000 })
					$($('.canvas-container')[0]).css({ zIndex: 2000 })
					break;
				case 'oc':
					$('.canvas-container').css({ zIndex: -2000 })
					$('#textillateContainer').css({ zIndex: -2000 })
					$($('.canvas-container')[1]).css({ zIndex: 2000 })
					break;
				case 'txt':
					$('.canvas-container').css({ zIndex: -2000 })
					$('#textillateContainer').css({ zIndex: 2000 })
					break;
			}
		}//end moveToFront
		
		//play from files
		var openFile = function(event) {
			var input = event.target;

			var readFile = (filename) => {
				if(!filename) return "{}"
				var promise = new Promise(function(resolve, reject) {
					var reader = new FileReader();
					reader.onload = function(){
					  var text = reader.result;
					  console.log(reader.result.substring(0, 200));
					  resolve(text)
					};
					reader.readAsText(filename);
				});
				
				return promise
			} //
			
			var len = input.files.length
			
			var getFile = nm => {
				var x = range(0,len).find(i => input.files[i].name.indexOf(nm) > 0);
				return input.files[x]
			}
			
			Promise.all([
				readFile(getFile('_pc')),
				readFile(getFile('_oc')),
				readFile(getFile('_txt')),
			]).then(data => {
				var pcData = JSON.parse(data[0])
				var ocData = JSON.parse(data[1])
				var txtData = JSON.parse(data[2])
				
				var frames = obj => Object.keys(obj).map(x => Number.parseInt(x)).sort((a,b)=> a-b);
				
				playRecording(40, {
					pc: [pcData, frames(pcData)],
					oc: [ocData, frames(ocData)],
					txt: [txtData, frames(txtData)]
				});
				stopPlayback = true;
				
				moveToFront('pc')
				$('#toolbar1-buttons').hide()
				$('#drawing-mode-options').hide()
				$("#recordingFileChooserDialog" ).dialog('destroy')
				
			}).finally(data => {
				console.log(data)
			});
			
		  }; //end openFile
    </script>

    <div id="drawing-toolbar" style="display: inline-block; margin-left: 10px;position: absolute; left: 0; top: 50; z-index: 1000000; height: 0" class="ui-draggable ui-draggable-handle">
        <img id="toolbarToggle1" style="margin-bottom: 20px;margin-right: 10px;width:25px; height: 25px;" onclick="$('#toolbar1-buttons').toggle();" src="https://storage.googleapis.com/cupitor-220103.appspot.com/images/drawer_icon.png">

        <div id="toolbar1-buttons">
            <button id="flip-drawing" class="btn btn-info">Flip Drawing Mode</button><br><br>
            <button id="undo" class="btn btn-info" onclick="undoDrawing(event)">Undo</button> <span> &nbsp;&nbsp;&nbsp;</span>
            <button id="redo" class="btn btn-info" onclick="redoDrawing(event)">Redo</button><br>

            <br>
            <label for="drawing-mode-selector">Mode:</label>
            <select id="drawing-mode-selector">
                <option>Pencil</option>
                <option>Circle</option>
                <option>Spray</option>
                <option>Pattern</option>

                <option>hline</option>
                <option>vline</option>
                <option>square</option>
                <option>diamond</option>
                <option>texture</option>
            </select><br>
            <br>
            <label for="drawing-line-width">Line width:</label>
            <span class="info">2</span><input type="range" value="2" min="0" max="150" id="drawing-line-width"><br>
            <br>
            <label for="drawing-color">Line color:</label>
            <input type="color" value="#005E7A" id="drawing-color"><br>
            <br>
            <label for="drawing-shadow-color">Shadow color:</label>
            <input type="color" value="#005E7A" id="drawing-shadow-color"><br>
            <br>
            <label for="drawing-shadow-width">Shadow width:</label>
            <span class="info">0</span><input type="range" value="0" min="0" max="50" id="drawing-shadow-width"><br>
            
            <br>
            <label for="drawing-shadow-offset">Shadow offset:</label>
            <span class="info">0</span><input type="range" value="0" min="0" max="50" id="drawing-shadow-offset"><br>
            <br><button id="clear-canvas" class="btn btn-info">Clear</button>
        </div>
    </div>

	<div id="rollbackConfirmationDialog" title="Rollback Recording!" style="display: none;">
	  <p>Select the time where to rollback:</p>
	  <div class="slider"></div>
	  <br><br>
	  <div>
		Selected Value: <span class="info"></span>
		
	  </div>
	</div>
	
	<div id="recordingFileChooserDialog" title="Choose Recording Files!" style="display: none; z-index: 5000">
	  <p>Choose Files:</p>
	  <input type="file" accept="text/plain" onchange="openFile(event)" id="recordingFiles" multiple="multiple">
	  
	  <div>
		OR
	  </div>
	  
	</div>
	
	<div id="playbackControls" style="display: none; position:fixed; bottom:0;width:100%;">
		<table style="width:100%">
		  <tr>
			<th style="width: 20%;"><span class="time"style="float: right;margin-right: 30px;"></span></th>
			<th style="width: 60%;"> <div class="slider"></div> </th> 
			<th><span class="time" style="float: left;margin-left:30px"></span></th>
		  </tr>
		</table>
		 
	</div>
	
    <div id="toolbar" style="display: inline-block; margin-left: 10px;position: absolute; right: -10; top: 50; z-index: 1000000; height: 0">
        <img id="toolbarToggle" style="margin-bottom: 20px;margin-right: 10px;width:25px; height: 25px;" onclick="$('#drawing-mode-options').toggle();" src="https://storage.googleapis.com/cupitor-220103.appspot.com/images/drawer_icon.png"></img>

        <select id="savePoints" style="margin-right: 30px;float: right;" onchange="restoreCanvas()"><option >0</option></select>


        <div id="drawing-mode-options" style="background: rgba(15, 14, 14, 0.4);padding-left: 10px;padding-top: 10px;">

			
			<button id="record-launch" class="btn btn-info" onclick="initializeRecording()">Record</button>
			<button id="record-play-launch" class="btn btn-info" onclick="launchRecordingDialog()">Play Recording</button>
			<button id="rollbackRecording" onclick="launchRollbackRecording()">Rollback Recording</button>
            <br><br>
			<button id="delete-selected" class="btn btn-info" onclick="deleteSelectedObjects()">Delete</button>
			<button id="record-play-save" class="btn btn-info" onclick="saveRecording()">Save Recording</button>
			<br> <br>
			
            <button class="btn btn-info" onclick="Copy(pc)">Copy</button>
            <button class="btn btn-info" onclick="Paste(pc)">Paste</button>
            <button class="btn btn-info" onclick="degroup(pc)">Ungroup</button>

            <br><br>

            <button id="create-text" class="btn btn-info">Text</button>
            <button id="create-small-text" class="btn btn-info">Small Text</button>
            <button id="create-rect-text" class="btn btn-info">[]</button>

            <br><br>
            <button id="bluen" class="btn btn-info" onclick="changeCircleColor('blue')">BL</button>
            <button id="reden" class="btn btn-info" onclick="changeCircleColor('red')">Red</button>
            <button id="greenen" class="btn btn-info" onclick="changeCircleColor('green')">Gr</button>
            <button id="whiten" class="btn btn-info" onclick="changeCircleColor('white')">Wh</button>
            <br><br>
            <button id="greenen" class="btn btn-info" onclick="zoomSelectedObject(true)" style="margin-right:10px;">+</button>
            <button id="whiten" class="btn btn-info" onclick="zoomSelectedObject(false)" style="margin-right:10px;">-</button>

            <button id="arrow" class="btn btn-info" onclick="arrowButton()">--></button>
            <br><br>

            <button id="flipConnectionMode" class="btn btn-info" onclick="flipConnectionMode(event)" style="">Connect</button>
            <button id="makeTree" class="btn btn-info" onclick="onMakeTreeClick(event)" style="">MakeTree</button>
            <button id="removeTree" class="btn btn-info" onclick="onRemoveTreeClick(event)" style="">RemoveTree</button>

            <br><br>

            <button id="create-array" class="btn btn-info" onclick="window.insertArray=true" style="margin-right:10px;">Array</button>

            <button id="insert-matex" class="btn btn-info" onclick="window.signalMatexInsertion=true;">Matex</button>
            <button id="insert-image" class="btn btn-info" onclick="window.signalImageInsertion=true;">Image</button>
            <br><br>
            <button id="save" style="margin-right:10px;" onclick="saveCanvas()">Save</button>
            <button id="newCanvas" onclick="newCanvas()"> New </button>
            <br><br>

            <br><br>
            <span id="instruction" style="width:150px"></span>

        </div>
    </div>
    <script >
		  
          var drawingModeEl = $('#drawing-mode'),
              drawingOptionsEl = $('#drawing-mode-options'),
              drawingColorEl = $('#drawing-color'),
              drawingShadowColorEl = $('#drawing-shadow-color'),
              drawingLineWidthEl = $('#drawing-line-width'),
              drawingShadowWidth = $('#drawing-shadow-width'),
              drawingShadowOffset = $('#drawing-shadow-offset'),
              clearEl = $('#clear-canvas');

          clearEl.click(function() { oc.clear() });

          drawingColorEl.change(function(e) {
              oc.freeDrawingBrush.color = this.value;
          });
          drawingShadowColorEl.change(function() {
            oc.freeDrawingBrush.shadow.color = this.value;
          });
          drawingLineWidthEl.change( function() {
            oc.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
            this.previousSibling.innerHTML = this.value;
          });
          drawingShadowWidth.change(function() {
            oc.freeDrawingBrush.shadow.blur = parseInt(this.value, 10) || 0;
            this.previousSibling.innerHTML = this.value;
          });
          drawingShadowOffset.change( function() {
            oc.freeDrawingBrush.shadow.offsetX = parseInt(this.value, 10) || 0;
            oc.freeDrawingBrush.shadow.offsetY = parseInt(this.value, 10) || 0;
            this.previousSibling.innerHTML = this.value;
          });

          if (oc.freeDrawingBrush) {
            oc.freeDrawingBrush.color = drawingColorEl.val() || 'black';
            oc.freeDrawingBrush.width = parseInt(drawingLineWidthEl.val(), 10) || 1;
            oc.freeDrawingBrush.shadow = new fabric.Shadow({
              blur: parseInt(drawingShadowWidth.val(), 10) || 0,
              offsetX: 0,
              offsetY: 0,
              affectStroke: true,
              color: drawingShadowColorEl.val() || 'black',
            });
          };
    </script>
    <script type="text/javascript">
        localStorage.setItem('pc', JSON.stringify({}))
        localStorage.setItem('oc', JSON.stringify({}))
        if (location.hash.indexOf('debug') >= 0) alert(window.innerWidth + "," + window.innerHeight)
        if (window.innerWidth < window.innerHeight) {
            $('#toolbar').css({
                position: 'absolute',
                bottom: 0
            })
        }

        $('body').scroll(function(e) {
            console.log('resized')

        });

        $(document).ready(e => {

            $('#toolbar').draggable();
        });

        function saveCanvas() {
            var idx = window.savePoint || 0;

            localStorage.setItem('pc_' + idx, JSON.stringify(pc.toDatalessJSON()))
            localStorage.setItem('oc_' + idx, JSON.stringify(oc.toDatalessJSON()))

        }

        function restoreCanvas() {
            var idx = Number.parseInt($('#savePoints').val())
            saveCanvas()
            window.savePoint = idx;
            pc.clear();
            oc.clear();
            var data = JSON.parse(localStorage.getItem('pc_' + idx))
            pc.loadFromDatalessJSON(data)

            pc.renderAll();
            var data1 = JSON.parse(localStorage.getItem('oc_' + idx))
            oc.loadFromDatalessJSON(data1)
            oc.renderAll();
        }

        function newCanvas() {
            saveCanvas()
            var idx = $('#savePoints option').length
            pc.clear();
            oc.clear();
            $('#savePoints').append('<option>' + idx + '</option>')
            $('#savePoints').val(idx + '')

            window.savePoint = idx;
        }


        $('#create-text').click(e => {
            window.insertText = true;
        })
        $('#create-small-text').click(e => {
            window.insertSmallText = true;
        })

        $('#create-rect-text').click(e => {
            window.insertRectText = true;
        })
        $('#flip-drawing').click(e => {
            if (window.overlayCanvasHidden) moveToFront('oc')
            else moveToFront('pc')
        })
        pc.on('object:selected', function(e) {
            var obj = e.target
            if (window.connectionMode) {
                if (!window.firstOfConnection) firstOfConnection = obj
                else {
                    makeConnection(e)
                    flipConnectionMode()
                }

            }
        });

        pc.on('object:removed', e => {
            console.log(e.target);
            var obj = e.target;
            if (obj.treeConnection && obj.treeConnection.outgoing) {
                obj.treeConnection.outgoing.lines.forEach(l => {
                    pc.remove(l);
                })
            }
        })
        pc.on('object:moving', e => {
            var t = e.target;
            var getPointCoords = (obj, pt) => {
                if (pt == 'mt') {
                    return obj.aCoords.mt || {
                        y: obj.oCoords.tl.y,
                        x: obj.oCoords.tl.x + obj.width / 2
                    }
                }
                if (pt == 'mb') {
                    return obj.aCoords.mb || {
                        y: obj.oCoords.bl.y,
                        x: obj.oCoords.bl.x + obj.width / 2
                    }
                }
            }

            if (t.treeConnection) {
                var inward = t.treeConnection.incoming || {}
                var outward = t.treeConnection.outgoing || {}

                if (inward.lines && inward.point) {
                    var p = getPointCoords(t, inward.point)
                    inward.lines.forEach(l => {
                        l.set('x2', p.x);
                        l.set('y2', p.y);
                        t.setCoords();
                        l.setCoords();
                        pc.renderAll();
                    });
                }
                if (outward.lines && outward.point) {
                    var p = getPointCoords(t, outward.point)
                    outward.lines.forEach(l => {
                        l.set('x1', p.x);
                        l.set('y1', p.y);
                        t.setCoords();
                        l.setCoords();
                        pc.renderAll();
                    });
                }

            }
        });

        oc.on('mouse:up', function(e) {
            $('#drawing-mode-options').hide();
            $('#toolbar1-buttons').hide();
        })
        pc.on('mouse:up', function(e) {
            $('#drawing-mode-options').hide();
            $('#toolbar1-buttons').hide();

            if (!e.e) e.e = {}
            if (!e.e.clientX) e.e.clientX = 10;
            if (!e.e.clientY) e.e.clientY = 10;

            if (window.insertText) {
                var tb = textbox({
                    top: e.e.clientY,
                    left: e.e.clientX
                })
                pc.add(tb)

                pc.setActiveObject(tb)
                _.textboxes.push(tb)
                window.insertText = false;
            }
            if (window.insertSmallText) {
                var tb = textbox({
                    top: e.e.clientY,
                    left: e.e.clientX,
                    width: 25
                })
                pc.add(tb)

                pc.setActiveObject(tb)
                _.textboxes.push(tb)
                window.insertSmallText = false;
            }
            if (window.signalMatexInsertion) {
                window.signalMatexInsertion = false;
                window.matexInsertionPoint = {
                    top: e.e.clientY,
                    left: e.e.clientX
                }
                document.getElementById('mathjaxDialog').style.display = 'block';
            }
            if (window.signalImageInsertion) {
                window.signalImageInsertion = false;
                $('#imageInputDialog').show();
            }

            if (window.insertRectText) {
                window.insertRectText = false;
                var text = prompt('Enter text')
                if (!text) return;
                var tb = textInRect(text, e.e.clientX, e.e.clientY, pc, {}, {})
                tb.hasControls = false;
                pc.add(tb)
            }

            if (window.insertArray) {
                window.insertArray = false;
                var text = prompt('Enter text')
                if (!text) return;

                var ar = showArray(text.split(','), e.e.clientX, e.e.clientY, pc);
                pc.getObjects().forEach(o => o.hasControls = false);
            }

            if (window.arrowButtonClicked) {
                if (window.arrowButtonClicked.first) {
                    var a = window.arrowButtonClicked.first
                    pc.add(arrow(a.x, a.y, e.e.clientX, e.e.clientY, {
                        stroke: ($('#drawing-color').val() || 'black')
                    }))
                    window.arrowButtonClicked = null;
                } else {
                    window.arrowButtonClicked.first = {
                        x: e.e.clientX,
                        y: e.e.clientY
                    }
                }
            }
        })
        var mapping = {
            'l': 'clear-canvas',
            'Delete': 'delete-selected',
            'd': 'flip-drawing',
            't': 'create-small-text',
            'T': 'create-text',
            'r': 'reden',
            'g': 'greenen',
            'b': 'bluen',
            'e': 'execute-next',
            'w': 'whiten'
        }
        $(document).keyup(e => {
			if(e.keyCode == 32 && e.target == document.body) {
				e.preventDefault();
			}
			
            if (document.getElementById('mathjaxDialog').style.display == 'block') return false;
            if (pc.getActiveObject() && pc.getActiveObject().type == 'textbox' && pc.getActiveObject().isEditing) return;
            if (mapping[e.key]) $("#" + mapping[e.key]).click()
            if (e.keyCode == 187) { //zoom in
                zoomSelectedObject(true)
            }
			if(e.keyCode == 32){
				toggleRecording()
			}
            if (e.keyCode == 189) { //zoom out
                zoomSelectedObject(false)
            }
            if (e.keyCode == 46) {
                $('#delete-selected').click()
            }
            switch (e.keyCode) {
                case 37: //left
                    if(pc.getActiveObject())moveActiveObject('left', -10)
					else {
						if(playingMode){
							stopPlayback = true
							playerTimer -= 10
							if(playerTimer < playerTimerStart) playerTimer = playerTimerStart;
							$('#recording-info').html('Jumped To: '+playerTimer)
						}
					}
                    break
				case 67:
					if(e.ctrlKey) Copy(pc)
					break;
				case 86:
					if(e.ctrlKey) Paste(pc)
					break;				
                case 39: //right
                    if(pc.getActiveObject())moveActiveObject('left', 10)
					else {
						if(playingMode){
							stopPlayback = true
							playerTimer += 10
							if(playerTimer > playerTimerTotal) playerTimer = playerTimerTotal;
							$('#recording-info').html('Jumped To: '+playerTimer)
						}					
					}
                    break
                case 40: //down
                    moveActiveObject('top', 10)
                    break
                case 38: //up
                    moveActiveObject('top', -10)
                    break
                case 69:
                    editSelectedObject()
                    break
				case 88:
                    moveToFront('pc')
                    break
				case 89:
                    moveToFront('oc')
                    break
				case 90:
                    moveToFront('txt')
                    break
                default:
                    break
            }
        })
    </script>

    <script>
        function handleFileDialogButtons(src) {
            if (src == "OK") {
                var url = $('#imageInputUrl').val()
                if (url) {
                    fabric.Image.fromURL(url, function(oImg) {
                        oImg.set({
                            'left': 100
                        });
                        oImg.set({
                            'top': 100
                        });
                        pc.add(oImg);
                        $('#imageInputUrl').val('')
                    });
                } else {
                    //Handle file selection
                    var file = document.querySelector('#imageInputFile').files[0];
                    var reader = new FileReader();
                    reader.addEventListener("load", function() {
                        fabric.Image.fromURL(reader.result, function(oImg) {
                            oImg.set({
                                'left': 100
                            });
                            oImg.set({
                                'top': 100
                            });
                            pc.add(oImg);
                        });
                    }, false);
                    if (file) {
                        reader.readAsDataURL(file);
                    }
                }
                $('#imageInputDialog').hide();
            } else {
                $('#imageInputDialog').hide();
            }
        }
	
	
	
	var dmp = new diff_match_patch();
	
	function toggleRecording(){
		if(window.playingMode) {
			if(!window.stopPlayback) window.stopPlayback = true
			else window.stopPlayback = false;
			
			return;
		};
		window.recording = !window.recording
		if(!window.recording){
			$('#recording-info').html('Stopped at: '+recordingTimer)
		}
	}
	
	function initializeRecording(){
		//if(window.playingMode) return;
		if(window.playingMode){
			var conf = confirm('You Are In Playing Mode. U Sure To Record?')
			if(!conf) return;
			
			Object.keys(localStorage).filter(x => x.startsWith(`recording_`)).forEach(x => {
				localStorage.removeItem('recording_pc_'+x);
				localStorage.removeItem('recording_oc_'+x);
				localStorage.removeItem('recording_txt_'+x);
			})
			
			localStorage.clear();
		}
		$('#toolbarToggle').click()
		$('#toolbarToggle1').click()
				
		window.playingMode = false
		window.recording = true;
		window.prevCanvasStates = {}
		window.recordingTimer = window.recordingTimer || 0;
		
		if(!window.recordingName){
			window.recordingName = prompt('Name of recording?')
		}
		
		const changesInCanvas = (prevCanvasState,newCanvasState,name)=> {
			var diff = dmp.diff_main(JSON.stringify(prevCanvasState), JSON.stringify(newCanvasState), true);

			if(diff.length > 0){
				if (diff.length > 2) {
					dmp.diff_cleanupSemantic(diff);
				}
				  
				var patch_list = dmp.patch_make(JSON.stringify(prevCanvasState), JSON.stringify(newCanvasState), diff);
				patch_text = dmp.patch_toText(patch_list);
				
				if(patch_text.length > 0){
					return patch_text
				}
				
			};
			return null;
		}//changesInCanvas
		
		window.recordingInterval = setInterval(x => {
			if(!window.recording) return;
			
			var postToServer = (data, part) => $.ajax({
			   url: 'http://localhost:8081/api/recording/push?name='+window.recordingName+"&component="+part,
			   method: 'post',
			   data: JSON.stringify(data),
			   dataType: 'json',
			   contentType: 'application/json'
			})
			
			var newCanvasStates = {
				pc: pc.toDatalessJSON(),
				oc: oc.toDatalessJSON(),
				text: $('#textillateContainer').html()
			}
			try {
				
				var pcChanges = changesInCanvas(prevCanvasStates.pc || {}, newCanvasStates.pc)
				if(pcChanges){
					var key = ''+recordingTimer
					var data = {}
					data[key] = newCanvasStates.pc
					postToServer(data, 'pc')
					prevCanvasStates.pc = newCanvasStates.pc
				}
				
				var ocChanges = changesInCanvas(prevCanvasStates.oc || {}, newCanvasStates.oc)
				if(ocChanges){
					var key = ''+recordingTimer
					var data = {}
					data[key] = newCanvasStates.oc
					postToServer(data, 'oc')
					
					prevCanvasStates.oc = newCanvasStates.oc
				}
				
				var htmlChanges = changesInCanvas(prevCanvasStates.text || {}, newCanvasStates.text)
				if(htmlChanges.length && newCanvasStates.text){
					var key = ''+recordingTimer
					var data = {}
					data[key] = newCanvasStates.text
					postToServer(data, 'txt')
					
					prevCanvasStates.text = newCanvasStates.text
				}
			} catch(e){
				console.log('Probably quota of localStorage exceeded! Stopping Recording')
				recording = false
				
			}	
			
			
			$('#recording-info').html('Recording: '+window.recordingTimer)
			recordingTimer++;
		}, 4) //40 milliseconds
	
	}

	function closest (num, arr) {
		var mid;
		var lo = 0;
		var hi = arr.length - 1;
		while (hi - lo > 1) {
			mid = Math.floor ((lo + hi) / 2);
			if (arr[mid] < num) {
				lo = mid;
			} else {
				hi = mid;
			}
		}
		if (num - arr[lo] <= arr[hi] - num) {
			return arr[lo];
		}
		return arr[hi];
	}
			
	function snapValue(value, values){
		adjustedValue = closest(value, values) || value;
		console.log(`${value} snapped to ${adjustedValue}`)
		
		$( "#rollbackConfirmationDialog .slider" ).slider('value', adjustedValue)
		return adjustedValue
	}
	
	function launchRollbackRecording(){
		var saved = reconstructCanvasStates('pc')
		var savedTxt = reconstructCanvasStates('txt')
		var savedOc = reconstructCanvasStates('oc')
		
		var frames = saved[1] //sorted
		
		$( "#rollbackConfirmationDialog" ).dialog({
			buttons: [
				{
				  text: "Ok Rollback",
				  click: function() {
					$( this ).dialog( "close" );
					rollbackRecordingTo({pc: saved, oc: savedOc, txt: savedTxt}, Number.parseInt($('#rollbackConfirmationDialog span.info').html()))
				  }
				}
			]//buttons
		});
		
		moveToFront('txt')
		
		$("#rollbackConfirmationDialog .slider").slider({
			range: false,
			min: 0,
			max: frames[frames.length-1]+1,
			slide: (x,y) => {
				var val = snapValue(y.value, frames)
				$('#rollbackConfirmationDialog span.info').html(val)
			}
			
		}); //
		
	}
	
	function rollbackRecordingTo(saved,time){
			if(!time) return;
			
			pc.loadFromDatalessJSON(saved['pc'][0][time])
			pc.renderAll()
			if(saved['oc']){
				var x = closest(time, saved['oc'][1])
				oc.loadFromDatalessJSON(saved['oc'][0][x])
				oc.renderAll()
			}
			if(saved['txt']){
				var x = closest(time, saved['txt'][1])
				$('#textillateContainer').html(saved['txt'][0][x])
			}
			var toRemove = Object.keys(localStorage).filter(x => x.startsWith(`recording_pc_`)).map(x => Number.parseInt(x.split("_")[2])).filter(x => x > time)
			
			toRemove.forEach(x => localStorage.removeItem('recording_pc_'+x))
			
			console.log('Removed '+toRemove.length+' frames of pc!')
			
			toRemove = Object.keys(localStorage).filter(x => x.startsWith(`recording_oc_`)).map(x => Number.parseInt(x.split("_")[2])).filter(x => x > time)
			
			toRemove.forEach(x => localStorage.removeItem('recording_oc_'+x))
			
			console.log('Removed '+toRemove.length+' frames of oc!')
			
			window.recordingTimer = time;
			$('#recording-info').html('Rollbacked To: '+time);
			
			
	}
	

	  
	function reconstructCanvasStates(name){
		    var frames = Object.keys(localStorage).filter(x => x.startsWith(`recording_${name}_`)).map(x => Number.parseInt(x.split("_")[2])).sort((a,b)=> a-b);

			var reconstructedCanvasStates = {}
			var reducer = (initialOrAccumulator, currentValue) => {
				var patches = dmp.patch_fromText(localStorage[`recording_${name}_${currentValue}`]);
				var results = dmp.patch_apply(patches, initialOrAccumulator);
				reconstructedCanvasStates[currentValue] = JSON.parse(results[0]);
				return results[0]
			};
			frames.reduce(reducer, JSON.stringify({}))
				
			return [reconstructedCanvasStates, frames];
	}
	
	

	function launchRecordingDialog(){
		$( "#recordingFileChooserDialog" ).dialog({
			buttons: [
				{
				  text: "Play From LocalStorage",
				  click: function() {
					$( this ).dialog( "close" );
					playRecording(null)
				  }
				}
			]//buttons
		});
		moveToFront('txt')
		
	}
	
	function playRecording(speedInMilliseconds, data){
			console.log('Playing')
			window.recordingMode = false;
			window.playingMode = true;
			$('#toolbar1-buttons').hide()
			$('#drawing-mode-options').hide()
				
			speedInMilliseconds = speedInMilliseconds || 4;
			var x = null;
			var y = null;
			var z = null;
			
			if(data){
				x = data.pc
				y = data.oc
				z = data.txt
			} else {
				x = reconstructCanvasStates('pc')	
				y = reconstructCanvasStates('oc')	
				z = reconstructCanvasStates('txt')	
			}
			
			
			var reconstructedCanvasStatesPc = x[0]
			var reconstructedCanvasStatesOc = y[0]
			var reconstructedCanvasStatesTxt = z[0]
			var framesPc = x[1]
			var framesOc = y[1]
			var framesTxt = z[1]
			
			var count = Math.max(Math.max(framesPc[framesPc.length-1], framesOc[framesOc.length-1]) || 0, framesTxt[framesTxt.length-1] || 0) + 1
			window.playerTimerTotal = count;
			
			
			var source = Rx.Observable.interval(speedInMilliseconds).timeInterval().take(count);
			
			window.playerTimer = Math.min(Math.min(framesPc[0] || 0, framesOc[0]) || 0, framesTxt[0] || 0);
			window.playerTimerStart = playerTimer
			
			$('#playbackControls .slider').slider({
				min: playerTimer,
				max: count,
				step: 10,
				value: playerTimer,
				slide: (x,y) => {
					$('#playbackControls .slider').find(".ui-slider-handle").text(y.value);
					playerTimer = y.value
					stopPlayback = true;
					setTimeout(x => { stopPlayback = false; },2)
				}
			})
			$($('#playbackControls span.time')[0]).html(playerTimer)
			$($('#playbackControls span.time')[1]).html(count)
			
			$('#playbackControls').show().css({ zIndex: 100000 })
			
			var playerInterval = null;
			playerInterval = setInterval(x => {
				if(playerTimer > count){
					clearInterval(playerInterval)
					window.recordingTimer = playerTimer;
					return;
				}
				if(window.stopPlayback) return;
				
				$('#recording-info').html('Playing: '+playerTimer);
					
				var f = playerTimer;
				var statesPc = reconstructedCanvasStatesPc[f]
				if(statesPc){
					pc.loadFromDatalessJSON(statesPc, ()=> pc.renderAll());
				}
				
				var statesOc = reconstructedCanvasStatesOc[f]
				if(statesOc){
					oc.loadFromDatalessJSON(statesOc, ()=> oc.renderAll());
				}
				
				var statesTxt = reconstructedCanvasStatesTxt[f]
				if(statesTxt){
					$('#textillateContainer').html(statesTxt);
					$('#textillateContainer').css({ zIndex: 50000 })
				}
				$("#slider").val(playerTimer);
				$("#slider").slider("refresh");
				playerTimer++;
			}, 1);
			
		}//End playRecording
	
		function saveRecording(){
			var saved = reconstructCanvasStates('pc')
			var savedTxt = reconstructCanvasStates('txt')
			var savedOc = reconstructCanvasStates('oc')

			if(!window.recordingName){
				var name = prompt('Recording Name?')
				if(!name) name = new Date().toISOString();
				
			}
			
			var num = window.currentRecordingSliceNumber || 1
			download(JSON.stringify(saved[0]), `recording_pc.${num}.txt`,"plain/text")
			download(JSON.stringify(savedOc[0]), `recording_oc.${num}.txt`,"plain/text")
			download(JSON.stringify(savedTxt[0]), `recording_txt.${num}.txt`,"plain/text")
			
			window.currentRecordingSliceNumber++;
			
			localStorage.clear()
		}
		
		function download(data, filename, type) {
			var file = new Blob([data], {type: type});
			if (window.navigator.msSaveOrOpenBlob) // IE10+
				window.navigator.msSaveOrOpenBlob(file, filename);
			else { // Others
				var a = document.createElement("a"),
						url = URL.createObjectURL(file);
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				setTimeout(function() {
					document.body.removeChild(a);
					window.URL.revokeObjectURL(url);  
				}, 0); 
			}
		}

		$(document).ready(function() {
		  var icon = $('.play');
		  icon.click(function() {
			 icon.toggleClass('active');
			 return false;
		  });
		});
		
		document.onclick = e => {
			window.lastClickedX = e.clientX;
			window.lastClickedY = e.clientY;
		}
		
		document.onpaste = function (event) {
		  console.log(event)
		  // use event.originalEvent.clipboard for newer chrome versions
		  var items = (event.clipboardData  || event.originalEvent.clipboardData).items;
		  console.log(JSON.stringify(items)); // will give you the mime types
		  // find pasted image among pasted items
		  var blob = null;
		  for (var i = 0; i < items.length; i++) {
			if (items[i].type.indexOf("image") === 0) {
			  blob = items[i].getAsFile();
			}
		  }
		  // load image if there is a pasted image
		  if (blob !== null) {
			var reader = new FileReader();
			reader.onload = function(event) {
			  var url = event.target.result; // data url!
			  if(url.indexOf("data") >= 0){
				if(window.insertPastedImageIntoFabric){
					fabric.Image.fromURL(url, function(oImg) {
							oImg.set({
								'left': window.lastClickedX || 100
							});
							oImg.set({
								'top': window.lastClickedY || 100
							});
							oc.add(oImg);
					});
				} else {
				    var id = prompt('Enter id')
					if(id){
						var container = $('<div>').css({ display: 'inline-block', position: 'absolute'}).attr({'id': id})
						window.pastedItems = window.pastedItems || {}
						window.pastedItems[id] = 1;
						
						var img = $('<img>').attr({src: url})
						img.css({ left: window.lastClickedX || 100, top: window.lastClickedY || 100, width: '100%', height: '100%'})
						
						container.prepend(img)
						var i = new Image(); 

						i.onload = function(){
							console.log( i.width+", "+i.height );
							$('#textillateContainer').append(container)
							container.css({ width: i.width, height: i.height })
							container.resizable()
							container.draggable()
							moveToFront('txt')
						};

						i.src = url;
					}					
				}
				
			  }
			};
			reader.readAsDataURL(blob);
		  }
		}//onpaste
		
    </script>

    <div id="imageInputDialog" style="background: blue; color: white; display: none; z-index: 500000;position: absolute;left: 30%;top: 30%;width: 400px;height: 400px;border: 1px solid black;padding: 1%;">
        <input autofocus type="text" id="imageInputUrl" onkeyup="renderMath(event)">

        <input type="file" id="imageInputFile">

        <button onclick="handleFileDialogButtons('OK')">OK</button> <button onclick="handleFileDialogButtons('')">Close</button>
    </div>

    <div id="mathjaxDialog" style="background: blue; color: white; display: none; z-index: 500000;position: absolute;left: 30%;top: 30%;width: 400px;height: 400px;border: 1px solid black;padding: 1%;">
        <script>
            function renderMath(e) {
                if (e.keyCode == 13) {
                    drawMathSymbols(document.getElementById('mathtext').value, pc)
                    document.getElementById('mathjaxDialog').style.display = 'none';
                } else if (e.keyCode == 27) {
                    document.getElementById('mathjaxDialog').style.display = 'none';
                } else {
                    document.getElementById('representation').innerHTML = "\\(" + document.getElementById('mathtext').value + "\\)";
                    MathJax.Hub.Queue(['Typeset', MathJax.Hub, 'representation']);
                }
            }
        </script>
        <input autofocus type="text" id="mathtext" onkeyup="renderMath(event)">

        <div id="representation" style="margin-top: 20; padding: 15;">
        </div>
    </div>
</body>

</html>