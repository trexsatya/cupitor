<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <script src="/jquery.js"></script>
    <script></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="/fabric.min.js"></script>
    <script type="text/javascript" src="/algo.visual.toolbox.js"></script>
	<script type="text/javascript" src="/rx.all.min.js"></script>
    <!--<script type="text/javascript" src="/textillate.js"></script> -->
	<script type="text/javascript" src="/diff-match-patch.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <link href="/select2.min.css" rel="stylesheet" />
    <script src="/select2.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG">
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript">
        Array.prototype.max = function() {
            return Math.max.apply(null, this);
        };
    </script>
    <style>
		.ui-dialog {
			z-index: 50000; !important
		}
		.rc-handle-container {
		  position: relative;
		}
		.rc-handle {
		  position: absolute;
		  width: 7px;
		  cursor: ew-resize;
		  margin-left: -3px;
		  z-index: 2;
		}
		table.rc-table-resizing {
		  cursor: ew-resize;
		}
		table.rc-table-resizing thead,
		table.rc-table-resizing thead > th,
		table.rc-table-resizing thead > th > a {
		  cursor: ew-resize;
		}
        canvas {
            height: 100vh;
            width: 100vw;
            display: block;
        }
		
		.play {
			display: block;
			width: 0;
			height: 0;
			border-top: 50px solid transparent;
			border-bottom: 50px solid transparent;
			border-left: 60px solid #2c3e50;
			margin: 0px auto 0px auto;
			position: relative;
			z-index: 1;
			transition: all 0.3s;
			-webkit-transition: all 0.3s;
			-moz-transition: all 0.3s;
			left: 10px;
		}
		
		.play:before {
			content: '';
			position: absolute;
			top: -75px;
			left: -115px;
			bottom: -75px;
			right: -35px;
			border-radius: 50%;
			border: 10px solid #2c3e50;
			z-index: 2;
			transition: all 0.3s;
			-webkit-transition: all 0.3s;
			-moz-transition: all 0.3s;
		}

		.play.active:after {
			content: '';
			opacity: 1;
			width: 50px;
			height: 80px;
			background: #2c3e50;
			position: absolute;
			right: 5px;
			top: -40px;
			border-left: 20px solid #2c3e50;
			box-shadow: inset 30px 0 0 0 #f9f9f9;
		}
		.play:after {
			content: '';
			opacity: 0;
			transition: opacity 0.6s;
			-webkit-transition: opacity 0.6s;
			-moz-transition: opacity 0.6s;
		}
		
		.play.active {
			border-color: transparent;
		}

         /* The switch - the box around the slider */
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        /* The slider */
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .4s;
          transition: .4s;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          -webkit-transition: .4s;
          transition: .4s;
        }

        input:checked + .slider {
          background-color: #2196F3;
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
          -webkit-transform: translateX(26px);
          -ms-transform: translateX(26px);
          transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
          border-radius: 34px;
        }

        .slider.round:before {
          border-radius: 50%;
        }

        .dialog {
            display: none;
            width: 60%;
        }

        .context-menu {
          position: absolute;
          z-index: 10;
        }
        .context-menu {
          display: none;
          position: absolute;
          z-index: 10;
        }

        .context-menu--active {
          display: block;
        }
    </style>

    <script>
        window.addEventListener("keydown",function (e) {
            if (e.keyCode === 114 || (e.ctrlKey && e.keyCode === 70)) {
                e.preventDefault();
                //Control F
                $('.commands-select').select2('open');
            }
        })

    </script>

    <script>
        function logItem(name, val, type, handlers) {
            handlers = handlers || {}
            window['globalVariableNames'][name] = val;
            var li = $(`<li> <i class="actionable fas fa-trash"></i> ${name}: ${type} </li>`)
            $(li).find("i").click(e => {
                handlers.delete(name)
                $(li).remove()
            });
            $('#item-variables').append(li)
        }
    </script>

    <script src="/play.js"></script>
    <link rel="stylesheet" href="/play.css">
    <link rel="stylesheet" href="/fontawesome-all.css">

    <script>

    </script>
</head>

<body >
    <div id="CMOGDAT-dialog" title="Enter required data" class="dialog">
            <input placeholder="Ex: [1, 2], [2, 3]" name="data" value="[1,2,3]">
            <button type="submit" onclick="createMatrix('#CMOGDAT-dialog')">OK</button>
            <br> <br>
            <input placeholder="Location on screen" value="400,80" name="location">
    </div>

    <div id="CAOGSD-dialog" title="Enter required data" class="dialog">
        <input placeholder="Ex: 1, 2, 3" name="data" value="1,2,3">
        <button type="submit" onclick="createArray('#CAOGSD-dialog')">OK</button>
        <br> <br>
        <input placeholder="Location on screen" value="400,80" name="location">
    </div>

    <div class="top-bar" style="width: 40%; margin-left: auto; margin-right: auto;">
        <select class="commands-select" name="command" style="width: 100%;">
            <option value="NULL"></option>
            <option value="CMOGDAT">Create Matrix Of Given Data</option>
            <option value="CMOGDIM">Create Matrix Of Given Dimension</option>
            <option value="CAOGSD">Create Array Of Given Data</option>
            <option value="CAOGSZ">Create Array Of Given Size</option>
        </select>
    </div>

    <div style="position: fixed; right: 0; top: 10%;z-index: 3000;">
        <ul id="item-variables">

        </ul>
    </div>

    <nav id="edit-table-cell-toolbar" style="display: none; position: fixed; z-index: 3000; background: #e2dbdb; padding: 10px; ">
        <ul class="" style="list-style: none;">
            <li class="">
                Value: <input type="text" name="value" onchange="">
            </li>
            <li class="">
                BG-Color: <input type="color" name="background" onchange="">
            </li>
            <li class="">
                FG-Color: <input type="color" name="color" onchange="">
            </li>
            <li class="">
                <button onclick="$('#edit-table-cell-toolbar').hide()">Close</button>
            </li>
        </ul>
    </nav>

    <script>
        // In your Javascript (external .js resource or <script> tag)
        $(document).ready(function() {
            $('.commands-select').select2();
        });
        $('.commands-select').on('select2:open', function (e) {
            var data = e.params.data;
            console.log(data);
            window.commandSelectionIsGoingOn = true;
        });

        $('.commands-select').on('select2:close', function (e) {
            var data = e.params.data;
            console.log(data);
            window.commandSelectionIsGoingOn = false;
        });

        $('.commands-select').on('select2:select', function (e) {
            var data = e.params.data;
            console.log(data);
            $(`#${data.id}-dialog`).dialog({
                width: 800,
                height: 400,
            })
            window.commandSelectionIsGoingOn = false;
        });
    </script>
	<canvas id="playerCanvas"></canvas>
    <canvas id="overlayCanvas" style="position: absolute;"></canvas>
	<span id="recording-info" style="    margin-left: 42%;top: 0; position: fixed;"></span>
	<div id="textillateContainer" style="width: 100%; height: 100%;position: absolute; top: 0; left: 0;"></div>
	
    <script type="text/javascript">
        var API_HOST = 'http://livintolearn.com/api';
        var id = window.location.hash.replace("#", "")

        window.onbeforeunload = function(){
          return 'Are you sure you want to leave?';
        };


        window.pc = new fabric.Canvas('playerCanvas')
        window._ = {
            textboxes: []
        }
        window.oc = new fabric.Canvas('overlayCanvas', {
            isDrawingMode: true
        });
        pc.setWidth(window.innerWidth)
        pc.setHeight(window.innerHeight)
        oc.setWidth(window.innerWidth)
        oc.setHeight(window.innerHeight)

        $('.canvas-container').css({
            position: 'absolute'
        });
        superimposeOverlayCanvas()
        moveToFront('pc')
    </script>
 
    <div style="display: inline-block;margin-left: 10px;position: absolute;left: 0;top: 8px;z-index: 1000000;height: 0;">
        <span style=""> <label class="switch">
          <input type="checkbox" id="eraser">
          <span class="slider round"></span>
            </label>
        </span>
    </div>
    

    <div id="drawing-toolbar" style="display: inline-block; margin-left: 10px;position: absolute; left: 0; top: 50; z-index: 1000000; height: 0" class="ui-draggable ui-draggable-handle">
        <img id="toolbarToggle1" style="margin-bottom: 20px;margin-right: 10px;width:25px; height: 25px;" onclick="$('#toolbar1-buttons').toggle();" src="https://storage.googleapis.com/cupitor-220103.appspot.com/images/drawer_icon.png">

        <div id="toolbar1-buttons">
            Drawing Mode:
            <label class="switch">
              <input type="checkbox" id="flip-drawing">
              <span class="slider round"></span>
            </label>
            <br><br>
            <button id="undo" class="btn btn-info" onclick="undoDrawing(event)">Undo</button> <span> &nbsp;&nbsp;&nbsp;</span>
            <button id="redo" class="btn btn-info" onclick="redoDrawing(event)">Redo</button><br>

            <br>
            <label for="drawing-mode-selector">Mode:</label>
            <select id="drawing-mode-selector">
                <option>Pencil</option>
                <option>Circle</option>
                <option>Spray</option>
                <option>Pattern</option>

                <option>hline</option>
                <option>vline</option>
                <option>square</option>
                <option>diamond</option>
                <option>texture</option>
            </select><br>
            <br>
            <label for="drawing-line-width">Line width:</label>
            <span class="info">2</span><input type="number" value="3" id="drawing-line-width"><br>
            
            <br>
            <label for="drawing-color">Line color:</label>
            <input type="color" value="#005E7A" id="drawing-color"><br>
            <br>
            <button id="clear-canvas" class="btn btn-info">Clear</button>
            
            <br><br>
            <label for="drawing-shadow-color">Shadow color:</label>
            <input type="color" value="#005E7A" id="drawing-shadow-color"><br>
            <br>
            <label for="drawing-shadow-width">Shadow width:</label>
            <span class="info">0</span><input type="number" value="0" id="drawing-shadow-width"><br>
            
            <br>
            <label for="drawing-shadow-offset">Shadow offset:</label>
            <span class="info">0</span><input type="number" value="0" id="drawing-shadow-offset"><br>
            <br>
        </div>
    </div>

	<div id="rollbackConfirmationDialog" title="Rollback Recording!" style="display: none;">
	  <p>Select the time where to rollback:</p>
	  <div class="slider"></div>
	  <br><br>
	  <div>
		Selected Value: <span class="info"></span>
		
	  </div>
	</div>
	
	<div id="recordingFileChooserDialog" title="Choose Recording Files!" style="display: none; z-index: 5000">
	  <p>Choose Files:</p>
	  <input type="file" accept="text/plain" onchange="openFile(event)" id="recordingFiles" multiple="multiple">
	  
	  <div>
		OR
	  </div>
	  
	</div>
	
	<div id="playbackControls" style="display: none; position:fixed; bottom:0;width:100%;">
		<table style="width:100%">
		  <tr>
			<th style="width: 20%;"><span class="time"style="float: right;margin-right: 30px;"></span></th>
			<th style="width: 60%;"> <div class="slider"></div> </th> 
			<th><span class="time" style="float: left;margin-left:30px"></span></th>
		  </tr>
		</table>
		 
	</div>
	
    <div id="toolbar" style="display: inline-block; margin-left: 10px;position: absolute; right: -10; top: 50; z-index: 1000000; height: 0">
        <img id="toolbarToggle" style="margin-bottom: 20px;margin-right: 10px;width:25px; height: 25px;" onclick="$('#drawing-mode-options').toggle();" src="https://storage.googleapis.com/cupitor-220103.appspot.com/images/drawer_icon.png"></img>

        <select id="savePoints" style="margin-right: 30px;float: right;" onchange="restoreCanvas()"><option >0</option></select>


        <div id="drawing-mode-options" style="background: rgba(15, 14, 14, 0.4);padding-left: 10px;padding-top: 10px;">

			
			<button id="record-launch" class="btn btn-info" onclick="initializeRecording()">Record</button>
			<button id="record-play-launch" class="btn btn-info" onclick="launchRecordingDialog()">Play Recording</button>
			<button id="rollbackRecording" onclick="launchRollbackRecording()">Rollback Recording</button>
            <br><br>
			<button id="delete-selected" class="btn btn-info" onclick="deleteSelectedObjects()">Delete</button>
			<button id="record-play-save" class="btn btn-info" onclick="saveRecording()">Save Recording</button>
			<br> <br>
			
            <button class="btn btn-info" onclick="Copy(pc)">Copy</button>
            <button class="btn btn-info" onclick="Paste(pc)">Paste</button>
            <button class="btn btn-info" onclick="degroup(pc)">Ungroup</button>

            <br><br>

            <button id="create-text" class="btn btn-info">Text</button>
            <button id="create-small-text" class="btn btn-info">Small Text</button>
            <button id="create-rect-text" class="btn btn-info">[]</button>

            <br><br>
            Color: <select onchange="changeCircleColor(this.value)">
              <option value="">--</option>
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="red">Red</option>
              <option value="black">Black</option>
              <option value="yellow">Yellow</option>
              <option value="pink">Pink</option>
              <option value="white">White</option>
            </select> 
           
            <br><br>
            <button id="greenen" class="btn btn-info" onclick="zoomSelectedObject(true)" style="margin-right:10px;">+</button>
            <button id="whiten" class="btn btn-info" onclick="zoomSelectedObject(false)" style="margin-right:10px;">-</button>

            <button id="arrow" class="btn btn-info" onclick="arrowButton()">--></button>
            <br><br>

            <button id="flipConnectionMode" class="btn btn-info" onclick="flipConnectionMode(event)" style="">Connect</button>
            <button id="makeTree" class="btn btn-info" onclick="onMakeTreeClick(event)" style="">MakeTree</button>
            <button id="removeTree" class="btn btn-info" onclick="onRemoveTreeClick(event)" style="">RemoveTree</button>

            <br><br>

            <button id="create-array" class="btn btn-info" onclick="window.insertArray=true; turnOffDrawing();" style="margin-right:10px;">Array</button>

            <button id="insert-matex" class="btn btn-info" onclick="window.signalMatexInsertion=true;turnOffDrawing();">Matex</button>
            <button id="insert-image" class="btn btn-info" onclick="window.signalImageInsertion=true;turnOffDrawing();">Image</button>
            <br><br>
            <button id="save" style="margin-right:10px;" onclick="saveCanvas()">Save</button>
            <button id="newCanvas" onclick="newCanvas()"> New </button>
            <br><br>

            <br><br>
            <span id="instruction" style="width:150px"></span>

        </div>
    </div>
    <script >
		  
          var drawingModeEl = $('#drawing-mode'),
              drawingOptionsEl = $('#drawing-mode-options'),
              drawingColorEl = $('#drawing-color'),
              drawingShadowColorEl = $('#drawing-shadow-color'),
              drawingLineWidthEl = $('#drawing-line-width'),
              drawingShadowWidth = $('#drawing-shadow-width'),
              drawingShadowOffset = $('#drawing-shadow-offset'),
              clearEl = $('#clear-canvas'),
              eraserEl = $('#eraser');

          clearEl.click(function() { 
              var yes = confirm('Are you sure?');
              if (yes) oc.clear();
           });

          drawingColorEl.change(function(e) {
              oc.freeDrawingBrush.color = this.value;
          });

          function turnOffDrawing(){
            if(flipDrawindEl.is(':checked')) {
                flipDrawindEl.click();
            }
          }

          eraserEl.change(e => {
            if(eraserEl.is(':checked')) {
                //Store 
                window.saved = window.saved || {};
                window.saved.eraserStoredData = window.saved.eraserStoredData || {}
                
                window.saved.eraserStoredData.drawingColor = drawingColorEl.val()
                window.saved.eraserStoredData.drawingLineWidth = drawingLineWidthEl.val()


                drawingColorEl.val('#ffffff')
                oc.freeDrawingBrush.color = drawingColorEl.val();

                drawingLineWidthEl.val(15);
                oc.freeDrawingBrush.width = parseInt(drawingLineWidthEl.val(), 10) || 15;

            } else {
                //Restore
                drawingColorEl.val(window.saved.eraserStoredData.drawingColor);
                drawingLineWidthEl.val(window.saved.eraserStoredData.drawingLineWidth);

                oc.freeDrawingBrush.color = drawingColorEl.val();
                oc.freeDrawingBrush.width = parseInt(drawingLineWidthEl.val(), 10) || 5;                
            }
          });

          drawingShadowColorEl.change(function() {
            oc.freeDrawingBrush.shadow.color = this.value;
          });
          drawingLineWidthEl.change( function() {
            oc.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
            this.previousSibling.innerHTML = this.value;
          });
          drawingShadowWidth.change(function() {
            oc.freeDrawingBrush.shadow.blur = parseInt(this.value, 10) || 0;
            this.previousSibling.innerHTML = this.value;
          });
          drawingShadowOffset.change( function() {
            oc.freeDrawingBrush.shadow.offsetX = parseInt(this.value, 10) || 0;
            oc.freeDrawingBrush.shadow.offsetY = parseInt(this.value, 10) || 0;
            this.previousSibling.innerHTML = this.value;
          });

          if (oc.freeDrawingBrush) {
            oc.freeDrawingBrush.color = drawingColorEl.val() || 'black';
            oc.freeDrawingBrush.width = parseInt(drawingLineWidthEl.val(), 10) || 1;
            oc.freeDrawingBrush.shadow = new fabric.Shadow({
              blur: parseInt(drawingShadowWidth.val(), 10) || 0,
              offsetX: 0,
              offsetY: 0,
              affectStroke: true,
              color: drawingShadowColorEl.val() || 'black',
            });
          };
    </script>
    <script type="text/javascript">
        localStorage.setItem('pc', JSON.stringify({}))
        localStorage.setItem('oc', JSON.stringify({}))
        if (location.hash.indexOf('debug') >= 0) alert(window.innerWidth + "," + window.innerHeight)
        if (window.innerWidth < window.innerHeight) {
            $('#toolbar').css({
                position: 'absolute',
                bottom: 0
            })
        }

        $('body').scroll(function(e) {
            console.log('resized')

        });

        $(document).ready(e => {

            $('#toolbar').draggable();
        });



        $('#create-text').click(e => {
            window.insertText = true;
            turnOffDrawing();
        })
        $('#create-small-text').click(e => {
            window.insertSmallText = true;
            turnOffDrawing();
        })

        $('#create-rect-text').click(e => {
            window.insertRectText = true;
            turnOffDrawing();          
        })

        var flipDrawindEl = $('#flip-drawing');
        flipDrawindEl.click(e => {
            if(flipDrawindEl.is(':checked')) {
                moveToFront('oc')
            } else {
                moveToFront('pc')
            }
        })
        pc.on('object:selected', function(e) {
            var obj = e.target
            if (window.connectionMode) {
                if (!window.firstOfConnection) firstOfConnection = obj
                else {
                    makeConnection(e)
                    flipConnectionMode()
                }

            }
        });

        pc.on('object:removed', e => {
            console.log(e.target);
            var obj = e.target;
            if (obj.treeConnection && obj.treeConnection.outgoing) {
                obj.treeConnection.outgoing.lines.forEach(l => {
                    pc.remove(l);
                })
            }
        })
        pc.on('object:moving', e => {
            var t = e.target;
            var getPointCoords = (obj, pt) => {
                if (pt == 'mt') {
                    return obj.aCoords.mt || {
                        y: obj.oCoords.tl.y,
                        x: obj.oCoords.tl.x + obj.width / 2
                    }
                }
                if (pt == 'mb') {
                    return obj.aCoords.mb || {
                        y: obj.oCoords.bl.y,
                        x: obj.oCoords.bl.x + obj.width / 2
                    }
                }
            }

            if (t.treeConnection) {
                var inward = t.treeConnection.incoming || {}
                var outward = t.treeConnection.outgoing || {}

                if (inward.lines && inward.point) {
                    var p = getPointCoords(t, inward.point)
                    inward.lines.forEach(l => {
                        l.set('x2', p.x);
                        l.set('y2', p.y);
                        t.setCoords();
                        l.setCoords();
                        pc.renderAll();
                    });
                }
                if (outward.lines && outward.point) {
                    var p = getPointCoords(t, outward.point)
                    outward.lines.forEach(l => {
                        l.set('x1', p.x);
                        l.set('y1', p.y);
                        t.setCoords();
                        l.setCoords();
                        pc.renderAll();
                    });
                }

            }
        });

        $('#drawing-mode-options').hide();
        $('#toolbar1-buttons').hide();

        oc.on('mouse:up', function(e) {
            $('#drawing-mode-options').hide();
            $('#toolbar1-buttons').hide();
        })
        pc.on('mouse:up', function(e) {
            $('#drawing-mode-options').hide();
            $('#toolbar1-buttons').hide();

            if (!e.e) e.e = {}
            if (!e.e.clientX) e.e.clientX = 10;
            if (!e.e.clientY) e.e.clientY = 10;

            if (window.insertText) {
                var tb = textbox({
                    top: e.e.clientY,
                    left: e.e.clientX
                })
                pc.add(tb)

                pc.setActiveObject(tb)
                _.textboxes.push(tb)
                window.insertText = false;
            }
            if (window.insertSmallText) {
                var tb = textbox({
                    top: e.e.clientY,
                    left: e.e.clientX,
                    width: 25
                })
                pc.add(tb)

                pc.setActiveObject(tb)
                _.textboxes.push(tb)
                window.insertSmallText = false;
            }
            if (window.signalMatexInsertion) {
                window.signalMatexInsertion = false;
                window.matexInsertionPoint = {
                    top: e.e.clientY,
                    left: e.e.clientX
                }
                document.getElementById('mathjaxDialog').style.display = 'block';
            }
            if (window.signalImageInsertion) {
                window.signalImageInsertion = false;
                $('#imageInputDialog').show();
            }

            if (window.insertRectText) {
                window.insertRectText = false;
                var text = prompt('Enter text')
                if (!text) return;
                var tb = textInRect(text, e.e.clientX, e.e.clientY, pc, {}, {})
                tb.hasControls = false;
                pc.add(tb)
            }

            if (window.insertArray) {
                window.insertArray = false;
                var text = prompt('Enter text')
                if (!text) return;

                var ar = showArray(text.split(','), e.e.clientX, e.e.clientY, pc);
                pc.getObjects().forEach(o => o.hasControls = false);
            }

            if (window.arrowButtonClicked) {
                if (window.arrowButtonClicked.first) {
                    var a = window.arrowButtonClicked.first
                    pc.add(arrow(a.x, a.y, e.e.clientX, e.e.clientY, {
                        stroke: ($('#drawing-color').val() || 'black')
                    }))
                    window.arrowButtonClicked = null;
                } else {
                    window.arrowButtonClicked.first = {
                        x: e.e.clientX,
                        y: e.e.clientY
                    }
                }
            }
        })
        var mapping = {
            'l': 'clear-canvas',
            'Delete': 'delete-selected',
            'd': 'flip-drawing',
            't': 'create-small-text',
            'T': 'create-text',
            'r': 'reden',
            'g': 'greenen',
            'b': 'bluen',
            'e': 'execute-next',
            'w': 'whiten'
        }
        $(document).keyup(e => {
            if($('.commands-select').is(":focus") || window.commandSelectionIsGoingOn){
                console.log('select is in focus. returning.')
                return;
            }
			if(e.keyCode == 32 && e.target == document.body) {
				e.preventDefault();
			}
			
            if (document.getElementById('mathjaxDialog').style.display == 'block') return false;
            if (pc.getActiveObject() && pc.getActiveObject().type == 'textbox' && pc.getActiveObject().isEditing) return;
            if (mapping[e.key]) $("#" + mapping[e.key]).click()
            if (e.keyCode == 187) { //zoom in
                zoomSelectedObject(true)
            }
			if(e.keyCode == 32){
				toggleRecording()
			}
            if (e.keyCode == 189) { //zoom out
                zoomSelectedObject(false)
            }
            if (e.keyCode == 46) {
                $('#delete-selected').click()
            }
            switch (e.keyCode) {
                case 37: //left
                    if(pc.getActiveObject())moveActiveObject('left', -10)
					else {
						if(window.playingMode){
							stopPlayback = true
							playerTimer -= 10
							if(playerTimer < playerTimerStart) playerTimer = playerTimerStart;
							$('#recording-info').html('Jumped To: '+playerTimer)
						}
					}
                    break
				case 67:
					if(e.ctrlKey) Copy(pc)
					break;
				case 86:
					if(e.ctrlKey) Paste(pc)
					break;				
                case 39: //right
                    if(pc.getActiveObject())moveActiveObject('left', 10)
					else {
						if(window.playingMode){
							stopPlayback = true
							playerTimer += 10
							if(playerTimer > playerTimerTotal) playerTimer = playerTimerTotal;
							$('#recording-info').html('Jumped To: '+playerTimer)
						}					
					}
                    break
                case 40: //down
                    moveActiveObject('top', 10)
                    break
                case 38: //up
                    moveActiveObject('top', -10)
                    break
                case 69:
                    editSelectedObject()
                    break
				case 88:
                    moveToFront('pc')
                    break
				case 89:
                    moveToFront('oc')
                    break
				case 90:
                    moveToFront('txt')
                    break
                default:
                    break
            }
        })
    </script>

    <script>
        function handleFileDialogButtons(src) {
            if (src == "OK") {
                var url = $('#imageInputUrl').val()
                if (url) {
                    fabric.Image.fromURL(url, function(oImg) {
                        oImg.set({
                            'left': 100
                        });
                        oImg.set({
                            'top': 100
                        });
                        pc.add(oImg);
                        $('#imageInputUrl').val('')
                    });
                } else {
                    //Handle file selection
                    var file = document.querySelector('#imageInputFile').files[0];
                    var reader = new FileReader();
                    reader.addEventListener("load", function() {
                        fabric.Image.fromURL(reader.result, function(oImg) {
                            oImg.set({
                                'left': 100
                            });
                            oImg.set({
                                'top': 100
                            });
                            pc.add(oImg);
                        });
                    }, false);
                    if (file) {
                        reader.readAsDataURL(file);
                    }
                }
                $('#imageInputDialog').hide();
            } else {
                $('#imageInputDialog').hide();
            }
        }
	
	
	
	var dmp = new diff_match_patch();
	
	function toggleRecording(){
		if(window.playingMode) {
			if(!window.stopPlayback) window.stopPlayback = true
			else window.stopPlayback = false;
			
			return;
		};
		window.recording = !window.recording
		if(!window.recording){
			$('#recording-info').html('Stopped at: '+recordingTimer)
		}
	}
	
	function initializeRecording(){
		//if(window.playingMode) return;
		if(window.playingMode){
			var conf = confirm('You Are In Playing Mode. U Sure To Record?')
			if(!conf) return;
			
			Object.keys(localStorage).filter(x => x.startsWith(`recording_`)).forEach(x => {
				localStorage.removeItem('recording_pc_'+x);
				localStorage.removeItem('recording_oc_'+x);
				localStorage.removeItem('recording_txt_'+x);
			})
			
			localStorage.clear();
		}
		$('#toolbarToggle').click()
		$('#toolbarToggle1').click()
				
		window.playingMode = false
		window.recording = true;
		window.prevCanvasStates = {}
		window.recordingTimer = window.recordingTimer || 0;
		
		if(!window.recordingName){
			window.recordingName = prompt('Name of recording?')
		}
		
		const changesInCanvas = (prevCanvasState,newCanvasState,name)=> {
			var diff = dmp.diff_main(JSON.stringify(prevCanvasState), JSON.stringify(newCanvasState), true);

			if(diff.length > 0){
				if (diff.length > 2) {
					dmp.diff_cleanupSemantic(diff);
				}
				  
				var patch_list = dmp.patch_make(JSON.stringify(prevCanvasState), JSON.stringify(newCanvasState), diff);
				patch_text = dmp.patch_toText(patch_list);
				
				if(patch_text.length > 0){
					return patch_text
				}
				
			};
			return null;
		}//changesInCanvas
		
		var zInices = ()=> {
			return [$($('.canvas-container')[0]).css('zIndex'), $($('.canvas-container')[1]).css('zIndex'), $('#textillateContainer').css('zIndex')];
		};
		
		window.recordingInterval = setInterval(x => {
			if(!window.recording) return;
			
			var postToServer = (data, part) => $.ajax({
			   url: 'http://localhost:8081/api/recording/push?name='+window.recordingName+"&component="+part,
			   method: 'post',
			   data: JSON.stringify(data),
			   dataType: 'json',
			   contentType: 'application/json'
			})
			
			var newCanvasStates = {
				pc: pc.toDatalessJSON(),
				oc: oc.toDatalessJSON(),
				text: $('#textillateContainer').html()
			}
			try {
				
				var pcChanges = changesInCanvas(prevCanvasStates.pc || {}, newCanvasStates.pc)
				if(pcChanges){
					var key = ''+recordingTimer
					var data = {}
					data[key] = { zIndex: zInices(), state: newCanvasStates.pc }
					postToServer(data, 'pc')
					prevCanvasStates.pc = newCanvasStates.pc
				}
				
				var ocChanges = changesInCanvas(prevCanvasStates.oc || {}, newCanvasStates.oc)
				if(ocChanges){
					var key = ''+recordingTimer
					var data = {}
					data[key] = { zIndex: zInices(), state: newCanvasStates.oc }
					postToServer(data, 'oc')
					
					prevCanvasStates.oc = newCanvasStates.oc
				}
				
				var htmlChanges = changesInCanvas(prevCanvasStates.text || {}, newCanvasStates.text)
				if(htmlChanges.length && newCanvasStates.text){
					var key = ''+recordingTimer
					var data = {}
					data[key] = { zIndex: zInices(), state: newCanvasStates.text };
					postToServer(data, 'txt')
					
					prevCanvasStates.text = newCanvasStates.text
				}
			} catch(e){
				console.log('Probably quota of localStorage exceeded! Stopping Recording')
				//recording = false
				
			}	
			
			
			$('#recording-info').html('Recording: '+window.recordingTimer)
			recordingTimer++;
		}, 4) //40 milliseconds
	
	}

	function closest (num, arr) {
		var mid;
		var lo = 0;
		var hi = arr.length - 1;
		while (hi - lo > 1) {
			mid = Math.floor ((lo + hi) / 2);
			if (arr[mid] < num) {
				lo = mid;
			} else {
				hi = mid;
			}
		}
		if (num - arr[lo] <= arr[hi] - num) {
			return arr[lo];
		}
		return arr[hi];
	}
			
	function snapValue(value, values){
		adjustedValue = closest(value, values) || value;
		console.log(`${value} snapped to ${adjustedValue}`)
		
		$( "#rollbackConfirmationDialog .slider" ).slider('value', adjustedValue)
		return adjustedValue
	}
	
	function launchRollbackRecording(){
		var saved = reconstructCanvasStates('pc')
		var savedTxt = reconstructCanvasStates('txt')
		var savedOc = reconstructCanvasStates('oc')
		
		var frames = saved[1] //sorted
		
		$( "#rollbackConfirmationDialog" ).dialog({
			buttons: [
				{
				  text: "Ok Rollback",
				  click: function() {
					$( this ).dialog( "close" );
					rollbackRecordingTo({pc: saved, oc: savedOc, txt: savedTxt}, Number.parseInt($('#rollbackConfirmationDialog span.info').html()))
				  }
				}
			]//buttons
		});
		
		moveToFront('txt')
		
		$("#rollbackConfirmationDialog .slider").slider({
			range: false,
			min: 0,
			max: frames[frames.length-1]+1,
			slide: (x,y) => {
				var val = snapValue(y.value, frames)
				$('#rollbackConfirmationDialog span.info').html(val)
			}
			
		}); //
		
	}
	
	function rollbackRecordingTo(saved,time){
			if(!time) return;
			
			pc.loadFromDatalessJSON(saved['pc'][0][time])
			pc.renderAll()
			if(saved['oc']){
				var x = closest(time, saved['oc'][1])
				oc.loadFromDatalessJSON(saved['oc'][0][x])
				oc.renderAll()
			}
			if(saved['txt']){
				var x = closest(time, saved['txt'][1])
				$('#textillateContainer').html(saved['txt'][0][x])
			}
			var toRemove = Object.keys(localStorage).filter(x => x.startsWith(`recording_pc_`)).map(x => Number.parseInt(x.split("_")[2])).filter(x => x > time)
			
			toRemove.forEach(x => localStorage.removeItem('recording_pc_'+x))
			
			console.log('Removed '+toRemove.length+' frames of pc!')
			
			toRemove = Object.keys(localStorage).filter(x => x.startsWith(`recording_oc_`)).map(x => Number.parseInt(x.split("_")[2])).filter(x => x > time)
			
			toRemove.forEach(x => localStorage.removeItem('recording_oc_'+x))
			
			console.log('Removed '+toRemove.length+' frames of oc!')
			
			window.recordingTimer = time;
			$('#recording-info').html('Rollbacked To: '+time);
			
			
	}
	

	  
	function reconstructCanvasStates(name){
		    var frames = Object.keys(localStorage).filter(x => x.startsWith(`recording_${name}_`)).map(x => Number.parseInt(x.split("_")[2])).sort((a,b)=> a-b);

			var reconstructedCanvasStates = {}
			var reducer = (initialOrAccumulator, currentValue) => {
				var patches = dmp.patch_fromText(localStorage[`recording_${name}_${currentValue}`]);
				var results = dmp.patch_apply(patches, initialOrAccumulator);
				reconstructedCanvasStates[currentValue] = JSON.parse(results[0]);
				return results[0]
			};
			frames.reduce(reducer, JSON.stringify({}))
				
			return [reconstructedCanvasStates, frames];
	}
	
	

	function launchRecordingDialog(){
		$( "#recordingFileChooserDialog" ).dialog({
			buttons: [
				{
				  text: "Play From LocalStorage",
				  click: function() {
					$( this ).dialog( "close" );
					playRecording(null)
				  }
				}
			]//buttons
		});
		moveToFront('txt')
		
	}
	
	function playRecording(speedInMilliseconds, data){
			console.log('Playing')
			window.recordingMode = false;
			window.playingMode = true;
			$('#toolbar1-buttons').hide()
			$('#drawing-mode-options').hide()
				
			speedInMilliseconds = speedInMilliseconds || 4;
			var x = null;
			var y = null;
			var z = null;
			
			if(data){
				x = data.pc
				y = data.oc
				z = data.txt
			} else {
				x = reconstructCanvasStates('pc')	
				y = reconstructCanvasStates('oc')	
				z = reconstructCanvasStates('txt')	
			}
			
			
			var reconstructedCanvasStatesPc = x[0]
			var reconstructedCanvasStatesOc = y[0]
			var reconstructedCanvasStatesTxt = z[0]
			var framesPc = x[1]
			var framesOc = y[1]
			var framesTxt = z[1]
			
			console.log('PcFrames:' + `${framesPc[0]} ${framesPc[framesPc.length-1]}`)
			console.log('OcFrames:' + `${framesOc[0]} ${framesOc[framesOc.length-1]}`)
			console.log('TxtFrames:' + `${framesTxt[0]} ${framesTxt[framesTxt.length-1]}`)
			
			var count = framesPc[framesPc.length-1]
			if(framesOc[framesOc.length-1] > count ) count = framesOc[framesOc.length-1]
			if(framesTxt[framesTxt.length-1] > count ) count = framesTxt[framesTxt.length-1]
			
			window.playerTimerTotal = count;
			
			
			var source = Rx.Observable.interval(speedInMilliseconds).timeInterval().take(count);
			
			window.playerTimer = framesPc[0]
			if(framesOc[0] < window.playerTimer ) window.playerTimer = framesOc[0]
			if(framesTxt[0] < window.playerTimer) window.playerTimer = framesTxt[0]
			
			window.playerTimerStart = playerTimer
			
			$('#playbackControls .slider').slider({
				min: playerTimer,
				max: count,
				step: 10,
				value: playerTimer,
				slide: (x,y) => {
					$('#playbackControls .slider').find(".ui-slider-handle").text(y.value);
					playerTimer = y.value
					stopPlayback = true;
					setTimeout(x => { stopPlayback = false; },2)
				}
			})
			$($('#playbackControls span.time')[0]).html(playerTimer)
			$($('#playbackControls span.time')[1]).html(count)
			
			$('#playbackControls').show().css({ zIndex: 100000 })
			
			var playerInterval = null;
			
			//This is so that I can add delays at frame points programmatically.
			var delayAmount = 0;
			var delayInterval = 0;
			
			playerInterval = setInterval(x => {
				if(playerTimer > count){
					clearInterval(playerInterval)
					window.recordingTimer = playerTimer;
					return;
				}
				if(window.stopPlayback) return;
				
				$('#recording-info').html('Playing: '+playerTimer);
				
				var f = playerTimer;
				var statesPc = reconstructedCanvasStatesPc[f] && reconstructedCanvasStatesPc[f].state
				if(statesPc){
					$($('.canvas-container')[0]).css({ zIndex: reconstructedCanvasStatesPc[f].zIndex[0] })
					$($('.canvas-container')[1]).css({ zIndex: reconstructedCanvasStatesPc[f].zIndex[1] })
					$('#textillateContainer').css({ zIndex: reconstructedCanvasStatesPc[f].zIndex[2] })
					pc.loadFromDatalessJSON(statesPc, ()=> pc.renderAll());
				}
				
				var statesOc = reconstructedCanvasStatesOc[f] && reconstructedCanvasStatesOc[f].state
				if(statesOc){
					$($('.canvas-container')[0]).css({ zIndex: reconstructedCanvasStatesOc[f].zIndex[0] })
					$($('.canvas-container')[1]).css({ zIndex: reconstructedCanvasStatesOc[f].zIndex[1] })
					$('#textillateContainer').css({ zIndex: reconstructedCanvasStatesOc[f].zIndex[2] })
					oc.loadFromDatalessJSON(statesOc, ()=> oc.renderAll());
				}
				
				var statesTxt = reconstructedCanvasStatesTxt[f] && reconstructedCanvasStatesTxt[f].state
				if(statesTxt){
					$($('.canvas-container')[0]).css({ zIndex: reconstructedCanvasStatesTxt[f].zIndex[0] })
					$($('.canvas-container')[1]).css({ zIndex: reconstructedCanvasStatesTxt[f].zIndex[1] })
					$('#textillateContainer').css({ zIndex: reconstructedCanvasStatesTxt[f].zIndex[2] })
					$('#textillateContainer').html(statesTxt);
					
				}
				$("#slider").val(playerTimer);
				$("#slider").slider("refresh");
				
				delayAmount = (window.delayPoints && window.delayPoints[playerTimer]) || 0
				
				if(delayInterval >= delayAmount) {
					delayAmount = 0;
					delayInterval = 0;
				}
				if(delayAmount == 0){
				    playerTimer++;
				} else {
					console.log('delaying')
					delayInterval++;
				}
				
			}, 1);
			
		}//End playRecording
	
		function saveRecording(){
			var saved = reconstructCanvasStates('pc')
			var savedTxt = reconstructCanvasStates('txt')
			var savedOc = reconstructCanvasStates('oc')

			if(!window.recordingName){
				var name = prompt('Recording Name?')
				if(!name) name = new Date().toISOString();
				
			}
			
			var num = window.currentRecordingSliceNumber || 1
			download(JSON.stringify(saved[0]), `recording_pc.${num}.txt`,"plain/text")
			download(JSON.stringify(savedOc[0]), `recording_oc.${num}.txt`,"plain/text")
			download(JSON.stringify(savedTxt[0]), `recording_txt.${num}.txt`,"plain/text")
			
			window.currentRecordingSliceNumber++;
			
			localStorage.clear()
		}
		
		function download(data, filename, type) {
			var file = new Blob([data], {type: type});
			if (window.navigator.msSaveOrOpenBlob) // IE10+
				window.navigator.msSaveOrOpenBlob(file, filename);
			else { // Others
				var a = document.createElement("a"),
						url = URL.createObjectURL(file);
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				setTimeout(function() {
					document.body.removeChild(a);
					window.URL.revokeObjectURL(url);  
				}, 0); 
			}
		}

		$(document).ready(function() {
		  var icon = $('.play');
		  icon.click(function() {
			 icon.toggleClass('active');
			 return false;
		  });
		});
		
		document.onclick = e => {
			window.lastClickedX = e.clientX;
			window.lastClickedY = e.clientY;
		}
		
		window.canPasteImageFromClipboard = true;
		document.onpaste = function (event) {
		  
		  console.log(event)
		  // use event.originalEvent.clipboard for newer chrome versions
		  var items = (event.clipboardData  || event.originalEvent.clipboardData).items;
		  console.log(JSON.stringify(items)); // will give you the mime types
		  // find pasted image among pasted items
		  var blob = null;
		  for (var i = 0; i < items.length; i++) {
			if (items[i].type.indexOf("image") === 0) {
			  blob = items[i].getAsFile();
			}
		  }
		  // load image if there is a pasted image
		  if (blob !== null) {
		    if(!canPasteImageFromClipboard) return;
			
			var reader = new FileReader();
			reader.onload = function(event) {
			  var url = event.target.result; // data url!
			  if(url.indexOf("data") >= 0){
			    
				if(window.insertPastedImageIntoFabric){
					fabric.Image.fromURL(url, function(oImg) {
							oImg.set({
								'left': window.lastClickedX || 100
							});
							oImg.set({
								'top': window.lastClickedY || 100
							});
							oc.add(oImg);
					});
				} else {
				    var id = prompt('Enter id')
					if(id){
						var container = $('<div>').css({ display: 'inline-block', position: 'absolute'}).attr({'id': id})
						window.pastedItems = window.pastedItems || {}
						window.pastedItems[id] = 1;
						
						var img = $('<img>').attr({src: url})
						img.css({ left: window.lastClickedX || 100, top: window.lastClickedY || 100, width: '100%', height: '100%'})
						
						container.prepend(img)
						var i = new Image(); 

						i.onload = function(){
							console.log( i.width+", "+i.height );
							$('#textillateContainer').append(container)
							container.css({ width: i.width, height: i.height })
							container.resizable()
							container.draggable()
							moveToFront('txt')
						};

						i.src = url;
					}					
				}
				
			  }
			};
			reader.readAsDataURL(blob);
		  }
		}//onpaste
		
    </script>

    <div id="imageInputDialog" style="background: blue; color: white; display: none; z-index: 500000;position: absolute;left: 30%;top: 30%;width: 400px;height: 400px;border: 1px solid black;padding: 1%;">
        <input autofocus type="text" id="imageInputUrl" onkeyup="renderMath(event)">

        <input type="file" id="imageInputFile">

        <button onclick="handleFileDialogButtons('OK')">OK</button> <button onclick="handleFileDialogButtons('')">Close</button>
    </div>

    <div id="mathjaxDialog" style="">
        <script>
            function renderMath(e) {
                if (e.keyCode == 13) {
                    drawMathSymbols(document.getElementById('mathtext').value, pc)
                    document.getElementById('mathjaxDialog').style.display = 'none';
                } else if (e.keyCode == 27) {
                    document.getElementById('mathjaxDialog').style.display = 'none';
                } else {
                    document.getElementById('representation').innerHTML = "\\(" + document.getElementById('mathtext').value + "\\)";
                    MathJax.Hub.Queue(['Typeset', MathJax.Hub, 'representation']);
                }
            }
        </script>
        <input autofocus type="text" id="mathtext" onkeyup="renderMath(event)">

        <div id="representation" style="margin-top: 20; padding: 15;"> </div>

         <div class="keyboard">
             <div class="key letter">
                0
              </div>
              <div class="key letter">
                1
              </div>
                <div class="key letter">
                2
              </div>
                <div class="key letter">
                3
              </div>
                <div class="key letter">
                4
              </div>
                <div class="key letter">
                5
              </div>
                <div class="key letter">
                6
              </div>
                <div class="key letter">
                7
              </div>
                <div class="key letter">
                8
              </div>
              <div class="key letter">
                9
              </div>
              <div class="key letter">
                +
              </div>
              <div class="key letter">
                -
              </div>
              <div class="key letter">
                *
              </div>  
              <div class="key letter">
                /
              </div>
              <div class="key letter">
                (
              </div>
              <div class="key letter">
                )
              </div>
              <div class="key letter" data-mathjax="\{">
                {
              </div>
              <div class="key letter" data-mathjax="\}">
                }
              </div>
             <div class="key letter">
                [
              </div>
                <div class="key letter">
                ]
              </div>
              <div class="key letter">
                ^
              </div>
              <div class="key letter">
                !
              </div>
              <div class="key letter">
                @
              </div>
              <div class="key letter"  data-mathjax="\#">
                #
              </div>
             <div class="key letter">
                $
              </div>
              <div class="key letter"  data-mathjax="\%">
                %
              </div>
              <div class="key letter"  data-mathjax="\&">
                &
              </div>
              <div class="key letter">
                ?
              </div>
              <div class="key letter">
                =
              </div>
              <div class="key letter">
                /
              </div>
              
              <div class="key letter">
                \
              </div>
              <div class="key letter">
                ~
              </div>
              <div class="key letter" data-mathjax="\alpha ">
                &alpha;
              </div>
              <div class="key letter" data-mathjax="\beta ">
                &beta;
              </div>
              <div class="key letter" data-mathjax="\gamma ">
                &gamma;
              </div>
              <div class="key letter" data-mathjax="\Gamma ">
                &Gamma;
              </div>
              <div class="key letter" data-mathjax="\delta ">
                &delta;
              </div>
              <div class="key letter" data-mathjax="\Delta ">
                &Delta;
              </div>
              <div class="key letter" data-mathjax="\epsilon ">
                &epsilon;
              </div>
              

              <input type="text" list="mathjaxFunctions" id="mathjaxFunctionInput" onchange="insertMathFromSelect(this)" style="margin-top: 10px;" />
              <datalist id="mathjaxFunctions">
                  <option value="\infty">Infinity</option>
                 
                  <option value="\sum {}">sum</option>
                  <option value="\text {}">text</option>
                  
                  <option value="\forall">forall</option>
                  <option value="\exists">exists</option>
                  <option value="\lor">or</option>
                  <option value="\land">and</option>
                  <option value="\pm">plus minus</option>
                  <option value="\neq">not equal</option>
                  <option value="\geq">greater eq</option>
                  <option value="\ll">much less</option>
                  <option value="\gg">much greater</option>
                  <option value="\approx">approx</option>
                  <option value="\supset">proper superset</option>
                  <option value="\supseteq">superset</option>
                  <option value="\subset">proper subset</option>
                  <option value="\subseteq">subset</option>
                  <option value="\emptyset">empty set</option>
                  <option value="\cup"> union </option>
                  <option value="\cap"> intersection </option>

                  <option value="\hat { }"> hat </option>
                  <option value="\sqrt[root]{ }"> square root </option>
                  <option value="\partial"> partial </option>
                  <option value="\cap"> intersection </option>
                  <option value="\cap"> intersection </option>
                  <option value="\cap"> intersection </option>
                  <option value="\cap"> intersection </option>
                  <option value="\cap"> intersection </option>

                  
                  <option value="\frac { }{ }">Fraction</option>
                  <option value="\in">In</option>
                  <option value="\left">Left</option>
                  <option value="\right">Right</option>
                  <option value="\overbrace {}">Overbrace</option>
                  <option value="\underbrace {}">Underbrace</option>
                  
                  <option value="\boldsymbol">Bold</option>
                  
              </datalist>  
            </div>
            
            <script type="text/javascript">
                function insertMathFromSelect(el) {
                    
                }

                function insertAtCursor(myField, myValue) {
                    //IE support
                    if (document.selection) {
                        myField.focus();
                        sel = document.selection.createRange();
                        sel.text = myValue;
                    }
                    //MOZILLA and others
                    else if (myField.selectionStart || myField.selectionStart == '0') {
                        var startPos = myField.selectionStart;
                        var endPos = myField.selectionEnd;
                        myField.value = myField.value.substring(0, startPos)
                            + myValue
                            + myField.value.substring(endPos, myField.value.length);
                        myField.selectionStart = startPos + myValue.length;
                        myField.selectionEnd = startPos + myValue.length;
                    } else {
                        myField.value += myValue;
                    }

                    myField.focus();
                } //end function


                $('.keyboard .key').click(e => {
                    var key = $(e.target).text().trim();
                    insertAtCursor( $('#mathtext')[0], $(e.target).data('mathjax') || key);

                });

                $('#mathjaxFunctionInput').keyup(e => {
                    
                    if(e.keyCode == 13) {
                        insertAtCursor( $('#mathtext')[0], $(e.target).val());    
                    }

                });

            </script>
            <style type="text/css">
                   #mathjaxDialog {
                        background: blue; 
                        color: white; 
                        display: none; 
                        z-index: 500000;
                        position: absolute;
                        left: 30%;
                        top: 30%;
                        width: 400px;
                        height: 400px;
                        border: 1px solid black;
                        padding: 1%;
                   }
                   @media (max-width: 767px) {
                      #mathjaxDialog {
                        left: 2%;
                        width: 99%;
                      }
                    }

                   .key{
                      width: 40px; height:40px;
                      display:block;
                      background-color:#333;
                      text-align: left;
                      padding-left: 8px;
                      line-height: 29px;
                      border-radius:2px;
                      float:left; margin-left: 2px;
                      margin-bottom:2px;
                      cursor: pointer;
                      transition: box-shadow 0.7s ease;
                    }

                    .section-a{width:650px; height:260px; float:left;}
                    .section-b{width:150px; height:260px; float:left;}

                    .function{font-size: 12px; width:30px; height:30px; margin-bottom:15px;}
                    .small{font-size:10px; line-height:13px; text-align: center; padding:0 5px; padding-top:2px; height:28px !important;}
                    .space1{margin-right: 43px !important;}
                    .space2{margin-right: 25px !important;}
                    .dual {font-size: 14px; line-height: 20px; width:30px; }
                    .backspace {width:84px; font-size: 12px;}
                    .tab {width: 50px; line-height: 40px; font-size:13px;}
                    .letter{width:30px;}
                    .slash{width:64px;}
                    .caps{width:70px; font-size:12px; line-height:18px;}
                    .enter{width:92px; line-height:40px; text-align: center; padding-left:0;}
                    .shift.left{width: 90px;line-height: 40px; font-size:13px;}
                    .shift.right{width: 104px;line-height: 40px; font-size:13px;}
                    .ctrl{width: 50px; line-height: 40px; font-size:13px;}
                    .space{width:234px;}
                    .arrows{position:relative; top:42px;}
                    .sec-func .key{width: 32px; font-size:10px; text-align:left; line-height:40px; float:left;}
                    .sec-func div.dual{line-height:20px;}
                    .arrows .key{text-align: center; padding-left: 7px; margin-left:2px;}
                    .hidden{visibility: hidden;}

                    .key:hover{box-shadow:0px 0px 10px #14B524; z-index:1000;}
            </style>   
        </div>
    </div>
</body>

</html>